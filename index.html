<!DOCTYPE html>
<html lang="hi">
<head>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä ‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§∏‡•á‡§µ‡§æ - ‡§ò‡§∞ ‡§™‡§∞ ‡§∏‡•á‡§µ‡§æ‡§è‡§Å</title>
  <!-- 
    !! ‡§Æ‡§π‡§§‡•ç‡§µ‡§™‡•Ç‡§∞‡•ç‡§£ !!
    Firebase Realtime Database (RTDB) SDK ‡§ï‡•ã ‡§á‡§∏ ‡§´‡§º‡§æ‡§á‡§≤ ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡§°‡§º‡•á‡§Ç‡•§
    ‡§â‡§¶‡§æ: <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
  -->
  <script type="module">
    import { initializeApp } from "firebase/app";
    import { getDatabase, ref, get, set } from "firebase/database"; // <-- RTDB Imports

    const firebaseConfig = {
      apiKey: "AIzaSyACNrzJgRGKmn8JsRuS_2b7RecPIfahTvQ",
      authDomain: "singup-aec8c.firebaseapp.com",
      databaseURL: "https://singup-aec8c-default-rtdb.firebaseio.com",
      projectId: "singup-aec8c",
      storageBucket: "singup-aec8c.appspot.com",
      messagingSenderId: "619246550282",
      appId: "1:619246550282:web:ab0bb54003d529ca820ef3",
      measurementId: "G-5KYVBVXQZP"
    };

    window.firebaseApp = initializeApp(firebaseConfig);
    window.firebaseDB = getDatabase(window.firebaseApp); // <-- RTDB Initialized
  </script>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <style>
    /* (CSS Styles) */
    body { font-family: 'Poppins', sans-serif; margin: 0; background: #f7f7f9; color: #333; padding-bottom: 60px; }
    .container { padding: 20px; max-width: 1000px; margin: auto; }
    h1 { text-align: center; color: #007bff; margin-bottom: 20px; }
    h2 { color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-top: 20px; font-weight: 600; }
    .content-section { display: none; }
    .content-section.active { display: block; }
    .search-container { position: relative; margin-bottom: 20px; }
    #categorySearchInput { width: 100%; padding: 10px 40px 10px 15px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
    .search-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #007bff; }
    #categorySuggestions {
        position: absolute; width: 100%; max-height: 200px; overflow-y: auto; background: #fff; border: 1px solid #ddd;
        border-radius: 0 0 8px 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 50; display: none; top: 100%; 
    }
    .suggestion-item { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #eee; color: #333; }
    .suggestion-item:last-child { border-bottom: none; }
    .suggestion-item:hover { background: #e6f7ff; font-weight: 600; }
    .suggestion-highlight { color: #007bff; font-weight: 700; }
    .category-navbar { background: #fff; padding: 8px 0; border-bottom: 1px solid #eee; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .category-list { display: flex; overflow-x: auto; list-style: none; padding: 0 10px; margin: 0; scrollbar-width: none; }
    .category-list::-webkit-scrollbar { display: none; }
    .category-item { flex-shrink: 0; margin-right: 10px; }
    .category-link { padding: 8px 15px; border-radius: 20px; border: 1px solid #ccc; color: #333; background: #fff; text-decoration: none; display: block; white-space: nowrap; }
    .category-link.active { background: #007bff; color: #fff; border-color: #007bff; }
    .karmchari-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-top: 20px; min-height: 200px; }
    .karmchari-card { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 3px 8px rgba(0,0,0,0.1); border-left: 5px solid #007bff; }
    .category-tag { background: #ffc107; padding: 3px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; display: inline-block; margin-bottom: 5px; }
    .contact-buttons { display: flex; gap: 10px; margin-top: 10px; }
    .contact-buttons a { flex: 1; text-align: center; padding: 10px; border-radius: 5px; color: #fff; text-decoration: none; font-weight: 600; }
    .call-btn { background: #dc3545; }
    .whatsapp-btn { background: #28a745; }
    .job-card { background: #e6f7ff; border: 1px solid #cceeff; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 5px solid #007bff; }
    .job-card p { margin: 5px 0; }
    .job-card strong { color: #007bff; }
    .job-card .action-buttons { margin-top: 10px; display: flex; gap: 10px; }
    .job-card .action-buttons button, .job-card .action-buttons a { padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; flex: 1; }
    .job-card .edit-btn { background: #ffc107; color: #333; }
    .job-card .delete-btn { background: #dc3545; color: white; }
    .form-container { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-top: 15px; }
    .form-group-icon { position: relative; margin-bottom: 15px; }
    .form-group-icon .material-icons { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #007bff; font-size: 20px; pointer-events: none; }
    .form-group-icon input, .form-group-icon select, textarea {
        width: 100%; padding: 10px 10px 10px 40px; border-radius: 5px; border: 1px solid #ccc;
        box-sizing: border-box; transition: border-color 0.3s; 
    }
    textarea { padding-left: 10px !important; } 
    select { -webkit-appearance: none; -moz-appearance: none; appearance: none; padding-right: 10px; }
    .form-btn { background: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; width: 100%; margin-top: 10px; font-weight: 600; transition: background 0.3s;}
    .form-btn:hover { background: #0056b3; }
    .loading-spinner { 
        border: 2px solid #f3f3f3; border-top: 2px solid #fff; border-radius: 50%; width: 16px; height: 16px; 
        animation: spin 0.8s linear infinite; margin-right: 8px; 
    }
    @keyframes spin { 
        0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } 
    }
    .message { margin-top: 10px; padding: 8px; border-radius: 4px; font-weight: bold; }
    .success-msg { color: #155724; background-color: #d4edda; border: 1px solid #c3e6cb; display: none; }
    .post-status { padding: 3px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; margin-left: 10px; }
    .status-pending { background: #ffc107; color: #333; }
    .status-approved { background: #28a745; color: white; }
    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; display: flex; justify-content: space-around; background: #fff; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 10; }
    .nav-item-bottom { display: flex; flex-direction: column; align-items: center; padding: 6px 0; font-size: 0.8em; text-decoration: none; color: #777; flex-grow: 1; min-width: 60px; }
    .nav-item-bottom.active { color: #007bff; font-weight: 600; }
    .nav-item-bottom span { font-size: 22px; }
  </style>
</head>
<body>

<div class="container">
  <!-- 1. üè† ‡§π‡•ã‡§Æ ‡§∏‡•á‡§ï‡•ç‡§∂‡§® (‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä) -->
  <div id="homeSection" class="content-section active">
    <h1>‡§π‡§Æ‡§æ‡§∞‡•á ‡§Ö‡§®‡•Å‡§≠‡§µ‡•Ä ‡§∏‡•á‡§µ‡§æ ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä</h1>
    <div class="search-container">
      <input type="text" id="categorySearchInput" placeholder="‡§∂‡•ç‡§∞‡•á‡§£‡•Ä ‡§ñ‡•ã‡§ú‡•á‡§Ç...">
      <span class="material-icons search-icon">search</span>
      <div id="categorySuggestions"></div>
    </div>
    <div class="category-navbar">
      <ul id="categoryNav" class="category-list">
        <!-- Categories load here -->
      </ul>
    </div>
    <div id="karmchariGrid" class="karmchari-grid">
      <p id="loadingMessage" style="text-align:center;">‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à... (Firebase ‡§∏‡•á)</p>
    </div>
  </div>

  <!-- 2. üíº ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§ï‡§æ‡§Æ -->
  <div id="availableJobsSection" class="content-section">
    <h1>‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§ï‡§æ‡§Æ (<span id="jobPostCount">0</span> ‡§è‡§ï‡•ç‡§ü‡§ø‡§µ ‡§™‡•ã‡§∏‡•ç‡§ü)</h1>
    <div id="availableJobsContainer">
        <!-- Job posts render here -->
        <p style="text-align:center;">‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§Æ‡•á‡§Ç ‡§ï‡•ã‡§à ‡§ï‡§æ‡§Æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§</p>
    </div>
  </div>

  <!-- 3. üë§ ‡§™‡•ç‡§∞‡•ã‡§´‡§º‡§æ‡§á‡§≤ (‡§ú‡•â‡§¨ ‡§™‡•ã‡§∏‡•ç‡§ü) -->
  <div id="profileSection" class="content-section">
    <h2>‡§ú‡•â‡§¨ ‡§∞‡§ø‡§ï‡•ç‡§µ‡•á‡§∏‡•ç‡§ü ‡§™‡•ã‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç</h2>
    <p>‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ‡§∏‡•á‡§µ‡§æ ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ø‡§π‡§æ‡§Å ‡§™‡•ã‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç‡•§</p>

    <form id="jobPostForm" class="form-container">
        <!-- Hidden field to track if we are editing -->
        <input type="hidden" id="editingPostId" value="">
        
        <label for="post_category">‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä ‡§∂‡•ç‡§∞‡•á‡§£‡•Ä</label>
        <div class="form-group-icon">
            <span class="material-icons">category</span>
            <select id="post_category" required>
                 <option value="">-- ‡§∂‡•ç‡§∞‡•á‡§£‡•Ä ‡§ö‡•Å‡§®‡•á‡§Ç --</option>
            </select>
        </div>

        <label for="post_work_details">‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£</label>
        <textarea id="post_work_details" rows="3" placeholder="‡§ú‡•à‡§∏‡•á: ‡§Æ‡•á‡§∞‡•á ‡§ò‡§∞ ‡§Æ‡•á‡§Ç ‡§™‡§æ‡§á‡§™ ‡§ü‡•Ç‡§ü ‡§ó‡§Ø‡§æ ‡§π‡•à, ‡§á‡§∏‡•á ‡§§‡•Å‡§∞‡§Ç‡§§ ‡§†‡•Ä‡§ï ‡§ï‡§∞‡§µ‡§æ‡§®‡§æ ‡§π‡•à‡•§" required></textarea>

        <label for="post_contact_name">‡§Ü‡§™‡§ï‡§æ ‡§®‡§æ‡§Æ</label>
        <div class="form-group-icon">
            <span class="material-icons">person</span>
            <input type="text" id="post_contact_name" required>
        </div>

        <label for="post_contact_number">‡§Ü‡§™‡§ï‡§æ ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§®‡§Ç‡§¨‡§∞ (WhatsApp/Call)</label>
        <div class="form-group-icon">
            <span class="material-icons">phone</span>
            <input type="text" id="post_contact_number" inputmode="numeric" placeholder="91XXXXXXXXXX" required>
        </div>

        <label for="post_duration">‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§ï‡§æ ‡§∏‡§Æ‡§Ø/‡§Ö‡§µ‡§ß‡§ø</label>
        <div class="form-group-icon">
            <span class="material-icons">schedule</span>
            <input type="text" id="post_duration" placeholder="‡§ú‡•à‡§∏‡•á: 4 ‡§ò‡§Ç‡§ü‡•á ‡§ï‡•á ‡§≤‡§ø‡§è, ‡§Ü‡§ú ‡§∂‡§æ‡§Æ ‡§ï‡•ã" required>
        </div>

        <button type="submit" class="form-btn" id="submitJobPostBtn">‡§ú‡•â‡§¨ ‡§∞‡§ø‡§ï‡•ç‡§µ‡•á‡§∏‡•ç‡§ü ‡§™‡•ã‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç</button>
        <p id="postMessage" class="message success-msg">‡§ú‡•â‡§¨ ‡§∞‡§ø‡§ï‡•ç‡§µ‡•á‡§∏‡•ç‡§ü ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§™‡•ã‡§∏‡•ç‡§ü ‡§ï‡•Ä ‡§ó‡§à! (‡§è‡§°‡§Æ‡§ø‡§® ‡§Ö‡§™‡•ç‡§∞‡•Ç‡§µ‡§≤ ‡§ï‡§æ ‡§á‡§Ç‡§§‡•õ‡§æ‡§∞ ‡§π‡•à)</p>
    </form>
    
    <h2 style="margin-top: 30px;">‡§Ü‡§™‡§ï‡•Ä ‡§™‡§ø‡§õ‡§≤‡•Ä ‡§™‡•ã‡§∏‡•ç‡§ü (<span id="myPostCount">0</span>)</h2>
    <div id="myPostsContainer">
        <!-- User's previous posts render here -->
        <p style="text-align: center; color: #555;">‡§Ü‡§™‡§ï‡•Ä ‡§ï‡•ã‡§à ‡§ú‡•â‡§¨ ‡§∞‡§ø‡§ï‡•ç‡§µ‡•á‡§∏‡•ç‡§ü ‡§™‡•ã‡§∏‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§ï‡•Ä ‡§ó‡§à ‡§π‡•à‡•§</p>
    </div>
  </div>
</div>

<!-- ‚öìÔ∏è ‡§¨‡•â‡§ü‡§Æ ‡§®‡•á‡§µ‡§ø‡§ó‡•á‡§∂‡§® (No 'Join' section) -->
<div class="bottom-nav">
  <a href="#" class="nav-item-bottom active" data-section="homeSection">
    <span class="material-icons">engineering</span> ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä
  </a>
  <a href="#" class="nav-item-bottom" data-section="availableJobsSection">
    <span class="material-icons">work_outline</span> ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§ï‡§æ‡§Æ
  </a>
  <a href="#" class="nav-item-bottom" data-section="profileSection">
    <span class="material-icons">person</span> ‡§™‡•ç‡§∞‡•ã‡§´‡§º‡§æ‡§á‡§≤
  </a>
</div>

<script>
// --- Shared Constants ---
const FIREBASE_DATA_KEY = 'serviceAppData'; // Main key for RTDB

let currentFilter = 'all';
let userTrackedContact = localStorage.getItem('user_tracked_contact') || ''; 
let categoriesList = []; 
let employeesList = [];
let jobPostsList = [];

const SEED_CATEGORIES = [
    {id:'cat_plumber',name:'‡§™‡•ç‡§≤‡§Ç‡§¨‡§∞'}, {id:'cat_electrician',name:'‡§á‡§≤‡•á‡§ï‡•ç‡§ü‡•ç‡§∞‡•Ä‡§∂‡§ø‡§Ø‡§®'}, 
    {id:'cat_carpenter',name:'‡§¨‡§¢‡§º‡§à'}, {id:'cat_cleaner',name:'‡§∏‡§´‡§æ‡§à ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä'}, 
    {id:'cat_gardener',name:'‡§Æ‡§æ‡§≤‡•Ä'}, {id:'cat_painter',name:'‡§™‡•á‡§Ç‡§ü‡§∞'},
    {id:'cat_ac_repair',name:'‡§è‡§∏‡•Ä ‡§∞‡§ø‡§™‡•á‡§Ø‡§∞'}, {id:'cat_cook',name:'‡§ñ‡§æ‡§®‡§æ ‡§¨‡§®‡§æ‡§®‡•á ‡§µ‡§æ‡§≤‡§æ'},
];


function generateId(prefix=''){return prefix+Date.now().toString(36)+Math.random().toString(36).substr(2,5);}

// --- Data Fetch/Save Functions (Now using REAL Firebase RTDB Logic) ---
async function fetchDataFromFirebase() {
    try {
        if (!window.firebaseDB) {
            console.error("Firebase DB not initialized. Using temporary fallback (check Console).");
            let data = JSON.parse(localStorage.getItem('TEMP_' + FIREBASE_DATA_KEY)) || { categories: [], employees: [], posts: [] };
            if (!data.categories || data.categories.length === 0) data.categories = SEED_CATEGORIES;
            categoriesList = data.categories || [];
            employeesList = data.employees || [];
            jobPostsList = data.posts || [];
            return { categories: categoriesList, employees: employeesList, posts: jobPostsList };
        }
        
        // RTDB Logic:
        const dbRef = ref(window.firebaseDB, FIREBASE_DATA_KEY);
        const snapshot = await get(dbRef);
        let data = snapshot.val() || { categories: [], employees: [], posts: [] };
        
        // Convert Firebase object lists back to JS arrays
        categoriesList = Array.isArray(data.categories) ? data.categories : Object.values(data.categories || {});
        employeesList = Array.isArray(data.employees) ? data.employees : Object.values(data.employees || {});
        jobPostsList = Array.isArray(data.posts) ? data.posts : Object.values(data.posts || {});

        // Load seed data if main data is empty 
        if (!categoriesList || categoriesList.length === 0) {
            categoriesList = SEED_CATEGORIES;
        }

        return { categories: categoriesList, employees: employeesList, posts: jobPostsList };
    } catch (e) {
        console.error("Error fetching data:", e);
        return { categories: SEED_CATEGORIES, employees: [], posts: [] };
    }
}

async function saveAllDataToFirebase(data) {
    try {
        if (!window.firebaseDB) {
            console.error("Firebase DB not initialized. Using temporary fallback (check Console).");
            localStorage.setItem('TEMP_' + FIREBASE_DATA_KEY, JSON.stringify(data));
            return;
        }
        
        // RTDB Logic:
        const dbRef = ref(window.firebaseDB, FIREBASE_DATA_KEY);
        await set(dbRef, data);
        
    } catch (e) {
        console.error("Save error:", e);
    }
}

function saveTrackedContact(contact){
    userTrackedContact = contact;
    localStorage.setItem('user_tracked_contact', contact);
}

function populatePostCategorySelect(categories) {
    const postSelect = document.getElementById('post_category');
    if (!postSelect) return; 

    const currentPostVal = postSelect.value; 
    postSelect.innerHTML = '<option value="">-- ‡§∂‡•ç‡§∞‡•á‡§£‡•Ä ‡§ö‡•Å‡§®‡•á‡§Ç --</option>';

    categories.forEach(cat => {
        postSelect.appendChild(new Option(cat.name, cat.id));
    });
    
    postSelect.value = currentPostVal; 
}

function renderCategoryNav(categories){
    const nav=document.getElementById('categoryNav');nav.innerHTML='';
    
    if (categories.length === 0) {
        nav.innerHTML = '<li class="category-item" style="color:#dc3545; padding: 0 20px;">‡§ï‡•ã‡§à ‡§∂‡•ç‡§∞‡•á‡§£‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡•§</li>';
        return;
    }
    
    const all=document.createElement('li');
    all.className='category-item';
    all.innerHTML=`<a href="javascript:void(0)" class="category-link ${currentFilter==='all'?'active':''}" data-category-id="all" data-category-name="‡§∏‡§≠‡•Ä ‡§∂‡•ç‡§∞‡•á‡§£‡§ø‡§Ø‡§æ‡§Ç">‡§∏‡§≠‡•Ä ‡§∂‡•ç‡§∞‡•á‡§£‡§ø‡§Ø‡§æ‡§Ç</a>`;
    all.querySelector('a').onclick=()=>selectCategory('all', '‡§∏‡§≠‡•Ä ‡§∂‡•ç‡§∞‡•á‡§£‡§ø‡§Ø‡§æ‡§Ç');
    nav.appendChild(all);

    categories.forEach(c=>{
        const li=document.createElement('li');
        li.className='category-item';
        li.innerHTML=`<a href="javascript:void(0)" class="category-link ${currentFilter===c.id?'active':''}" data-category-id="${c.id}" data-category-name="${c.name}">${c.name}</a>`;
        li.querySelector('a').onclick=()=>selectCategory(c.id, c.name);
        nav.appendChild(li);
    });
}

function setFilter(id){
    currentFilter=id;
    renderEmployees(employeesList, categoriesList, id);
    
    const input = document.getElementById('categorySearchInput');
    const cat = categoriesList.find(c => c.id === id);

    input.value = (id === 'all' || !cat) ? '' : cat.name;

    document.querySelectorAll('.category-link').forEach(l=>{
        const isActive = l.dataset.categoryId===id;
        l.classList.toggle('active', isActive);
        if(isActive) l.parentElement.scrollIntoView({ behavior: 'smooth', inline: 'center' });
    });
}

function renderEmployees(employees, categories, filter){
    const grid=document.getElementById('karmchariGrid');
    grid.innerHTML='';
    
    const categoryMap = categories.reduce((map, cat) => { map[cat.id] = cat.name; return map; }, {});
    
    const f=filter==='all'?employees:employees.filter(e=>e.categoryId===filter);
    
    if(!f.length){grid.innerHTML='<p style="text-align:center;color:red;">‡§ï‡•ã‡§à ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç‡•§</p>';return;}
    
    f.forEach(e=>{
        const c=categoryMap[e.categoryId] || '‡§Ö‡§ú‡•ç‡§û‡§æ‡§§';
        const cleanContact = String(e.contact).replace(/\D/g, ''); 
        const detailsText = e.details ? `\n\n‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä ‡§µ‡§ø‡§µ‡§∞‡§£:\n${e.details}` : '';
        const w=`https://wa.me/91${cleanContact}?text=${encodeURIComponent(`‡§®‡§Æ‡§∏‡•ç‡§§‡•á, ‡§Æ‡•Å‡§ù‡•á ${c} ‡§ï‡•Ä ‡§∏‡•á‡§µ‡§æ ‡§ö‡§æ‡§π‡§ø‡§è‡•§${detailsText}`)}`;
        
        const cardHTML = `
            <div class="karmchari-card">
                <div class="category-tag">${c}</div>
                <h3>${e.name}</h3>
                <p><strong>‡§Ö‡§®‡•Å‡§≠‡§µ:</strong> ${e.experience} ‡§∏‡§æ‡§≤</p>
                <p style="font-size:0.9em; color:#666;">${(e.details || '‡§ï‡•ã‡§à ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§®‡§π‡•Ä‡§Ç‡•§').substring(0, 50) + '...'}</p>
                <div class="contact-buttons">
                    <a href="tel:+91${cleanContact}" class="call-btn">‡§ï‡•â‡§≤ ‡§ï‡§∞‡•á‡§Ç</a>
                    <a href="${w}" target="_blank" class="whatsapp-btn">‡§µ‡•ç‡§π‡§æ‡§ü‡•ç‡§∏‡§è‡§™</a>
                </div>
            </div>`;
        
        grid.insertAdjacentHTML('beforeend', cardHTML);
    });
}

function renderSuggestions(query) {
    const suggestionsBox = document.getElementById('categorySuggestions');
    suggestionsBox.innerHTML = '';
    const lowerQuery = query.toLowerCase().trim();

    if (!lowerQuery) {
        suggestionsBox.innerHTML += `<div class="suggestion-item" data-category-id="all" data-category-name="‡§∏‡§≠‡•Ä ‡§∂‡•ç‡§∞‡•á‡§£‡§ø‡§Ø‡§æ‡§Ç">‡§∏‡§≠‡•Ä ‡§∂‡•ç‡§∞‡•á‡§£‡§ø‡§Ø‡§æ‡§Ç</div>`;
    }
    
    const filtered = categoriesList.filter(cat => cat.name.toLowerCase().includes(lowerQuery));

    if (filtered.length === 0 && lowerQuery) {
        suggestionsBox.style.display = 'none';
        return;
    }

    filtered.forEach(cat => {
        const highlightedName = cat.name.replace(new RegExp(lowerQuery, 'gi'), match => `<span class="suggestion-highlight">${match}</span>`);
        suggestionsBox.innerHTML += `<div class="suggestion-item" data-category-id="${cat.id}" data-category-name="${cat.name}">${highlightedName}</div>`;
    });

    suggestionsBox.style.display = 'block';

    suggestionsBox.querySelectorAll('.suggestion-item').forEach(item => {
        item.addEventListener('mousedown', function() { 
            selectCategory(this.dataset.categoryId, this.dataset.categoryName);
        });
    });
}

function selectCategory(categoryId, categoryName) {
    document.getElementById('categorySearchInput').value = categoryName === '‡§∏‡§≠‡•Ä ‡§∂‡•ç‡§∞‡•á‡§£‡§ø‡§Ø‡§æ‡§Ç' ? '' : categoryName; 
    document.getElementById('categorySuggestions').style.display = 'none'; 
    setFilter(categoryId); 
}

function setupCategorySearch() {
    const input = document.getElementById('categorySearchInput');
    const suggestionsBox = document.getElementById('categorySuggestions');
    
    input.addEventListener('input', () => renderSuggestions(input.value));
    input.addEventListener('focus', () => renderSuggestions(input.value));
    input.addEventListener('blur', () => setTimeout(() => { suggestionsBox.style.display = 'none'; }, 150));
    
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            const firstSuggestion = suggestionsBox.querySelector('.suggestion-item');
            if (firstSuggestion && suggestionsBox.style.display === 'block') {
                e.preventDefault();
                selectCategory(firstSuggestion.dataset.categoryId, firstSuggestion.dataset.categoryName);
            } else if (input.value.trim() === '') {
                 setFilter('all');
            }
        }
    });
}

// --- Available Jobs Renderer (Only shows approved posts) ---
function renderAvailableJobs(categories) {
    const container = document.getElementById('availableJobsContainer');
    const approvedPosts = jobPostsList.filter(p => p.isApproved === true); // FILTER FOR APPROVED
    document.getElementById('jobPostCount').textContent = approvedPosts.length;
    container.innerHTML = ''; 

    if (approvedPosts.length === 0) {
        container.innerHTML = '<p style="text-align:center;">‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§Æ‡•á‡§Ç ‡§ï‡•ã‡§à ‡§ï‡§æ‡§Æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§</p>';
        return;
    }

    approvedPosts.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)); 
    const categoryMap = categories.reduce((map, cat) => { map[cat.id] = cat.name; return map; }, {});

    approvedPosts.forEach(p => {
        const catName = categoryMap[p.category] || '‡§Ö‡§ú‡•ç‡§û‡§æ‡§§';
        const cleanContact = String(p.contactNumber).replace(/\D/g, ''); 
        
        const whatsappMessage = encodeURIComponent(`‡§®‡§Æ‡§∏‡•ç‡§§‡•á, ‡§Æ‡•à‡§Ç‡§®‡•á ‡§Ü‡§™‡§ï‡•Ä ‡§ú‡•â‡§¨ ‡§™‡•ã‡§∏‡•ç‡§ü (${catName}) ‡§¶‡•á‡§ñ‡•Ä ‡§π‡•à‡•§ ‡§Æ‡•à‡§Ç ‡§Ø‡§π ‡§ï‡§æ‡§Æ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§ï‡•ç‡§∑‡§Æ ‡§π‡•Ç‡§Å‡•§`);
        const w = `https://wa.me/91${cleanContact}?text=${whatsappMessage}`;

        container.innerHTML += `
            <div class="job-card">
                <p><strong>‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§∂‡•ç‡§∞‡•á‡§£‡•Ä:</strong> ${catName}</p>
                <p><strong>‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§µ‡§ø‡§µ‡§∞‡§£:</strong> ${p.details}</p>
                <p><strong>‡§ú‡§º‡§∞‡•Ç‡§∞‡§§:</strong> ${p.duration}</p>
                <p><strong>‡§™‡•ã‡§∏‡•ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§µ‡§æ‡§≤‡§æ:</strong> ${p.contactName}</p>
                <div class="action-buttons">
                    <a href="tel:+91${cleanContact}" class="delete-btn" style="background: #dc3545; color: white; flex: 1; text-align: center; line-height: 20px; text-decoration: none;">‡§ï‡•â‡§≤ ‡§ï‡§∞‡•á‡§Ç</a>
                    <a href="${w}" target="_blank" class="edit-btn" style="background: #28a745; color: white; flex: 1; text-align: center; line-height: 20px; text-decoration: none;">‡§µ‡•ç‡§π‡§æ‡§ü‡•ç‡§∏‡§è‡§™ ‡§™‡§∞ ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ï‡§∞‡•á‡§Ç</a>
                </div>
            </div>
        `;
    });
}

function resetJobPostForm(isUpdate=false) {
    document.getElementById('jobPostForm').reset();
    if (userTrackedContact) {
        document.getElementById('post_contact_number').value = userTrackedContact; 
    }
    document.getElementById('editingPostId').value = '';
    const btn = document.getElementById('submitJobPostBtn');
    btn.textContent = '‡§ú‡•â‡§¨ ‡§∞‡§ø‡§ï‡•ç‡§µ‡•á‡§∏‡•ç‡§ü ‡§™‡•ã‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç';
    btn.style.background = '#007bff';
    populatePostCategorySelect(categoriesList); 
    if(!isUpdate) document.getElementById('postMessage').style.display = 'none';
}

async function handleJobPost(e) {
    e.preventDefault();
    
    const id = document.getElementById('editingPostId').value;
    const category = document.getElementById('post_category').value;
    const details = document.getElementById('post_work_details').value.trim();
    const contactName = document.getElementById('post_contact_name').value.trim();
    const contactNumber = document.getElementById('post_contact_number').value.trim().replace(/\D/g, ''); 
    const duration = document.getElementById('post_duration').value.trim();
    
    const btn = document.getElementById('submitJobPostBtn');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.innerHTML = '<span class="loading-spinner"></span> <span>‡§™‡•ç‡§∞‡§∏‡§Ç‡§∏‡•ç‡§ï‡§∞‡§£...</span>';

    if (!category || !details || !contactName || contactNumber.length < 10 || !duration) {
        alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§≠‡•Ä ‡§´‡§º‡•Ä‡§≤‡•ç‡§° ‡§∏‡§π‡•Ä ‡§¢‡§Ç‡§ó ‡§∏‡•á ‡§≠‡§∞‡•á‡§Ç‡•§');
        btn.disabled = false; btn.innerHTML = originalText;
        return;
    }
    
    let posts = jobPostsList; 
    let message = '‡§ú‡•â‡§¨ ‡§∞‡§ø‡§ï‡•ç‡§µ‡•á‡§∏‡•ç‡§ü ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§™‡•ã‡§∏‡•ç‡§ü ‡§ï‡•Ä ‡§ó‡§à! (‡§è‡§°‡§Æ‡§ø‡§® ‡§Ö‡§™‡•ç‡§∞‡•Ç‡§µ‡§≤ ‡§ï‡§æ ‡§á‡§Ç‡§§‡•õ‡§æ‡§∞ ‡§π‡•à)';

    if (id) {
        const index = posts.findIndex(p => p.id === id);
        if (index !== -1) {
            posts[index] = { ...posts[index], category, details, contactName, contactNumber, duration, isApproved: false }; // Set to pending on edit
            message = '‡§ú‡•â‡§¨ ‡§∞‡§ø‡§ï‡•ç‡§µ‡•á‡§∏‡•ç‡§ü ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡•Ä ‡§ó‡§à! (‡§Ö‡§™‡•ç‡§∞‡•Ç‡§µ‡§≤ ‡§∞‡•Ä‡§∏‡•á‡§ü)';
        }
    } else {
        const newPost = { id: generateId(POST_PREFIX), category, details, contactName, contactNumber, duration, timestamp: Date.now(), isApproved: false };
        posts.push(newPost);
    }
    
    const adminData = await fetchDataFromFirebase();
    adminData.posts = posts;
    await saveAllDataToFirebase(adminData);
    jobPostsList = posts; 
    saveTrackedContact(contactNumber); 
    
    const postMsg = document.getElementById('postMessage');
    postMsg.textContent = message;
    postMsg.style.display = 'block';
    
    renderMyPosts(categoriesList);
    resetJobPostForm(true); 
    
    btn.disabled = false; btn.innerHTML = originalText;
    
    setTimeout(() => { 
        postMsg.style.display = 'none';
    }, 3000);
}

// --- My Posts Renderer (Shows ALL user posts, with status) ---
function renderMyPosts(categories) { 
     userTrackedContact = localStorage.getItem('user_tracked_contact') || ''; 
     const myPosts = jobPostsList.filter(p => p.contactNumber === userTrackedContact); 
     document.getElementById('myPostCount').textContent = myPosts.length;
     const container = document.getElementById('myPostsContainer');
     container.innerHTML = myPosts.length === 0 
         ? `<p style="text-align: center; color: #555;">‡§Ü‡§™‡§ï‡•Ä ‡§ï‡•ã‡§à ‡§ú‡•â‡§¨ ‡§∞‡§ø‡§ï‡•ç‡§µ‡•á‡§∏‡•ç‡§ü ‡§™‡•ã‡§∏‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§ï‡•Ä ‡§ó‡§à ‡§π‡•à‡•§</p>`
         : myPosts.map(p => {
             const cat = categories.find(c => c.id === p.category);
             const catName = cat ? cat.name : '‡§Ö‡§ú‡•ç‡§û‡§æ‡§§';
             const statusText = p.isApproved ? 'Approved' : 'Pending';
             const statusClass = p.isApproved ? 'status-approved' : 'status-pending';

             return `
                 <div class="job-card" id="my-post-${p.id}">
                     <p><strong>‡§∂‡•ç‡§∞‡•á‡§£‡•Ä:</strong> ${catName} <span class="post-status ${statusClass}">${statusText}</span></p>
                     <p><strong>‡§µ‡§ø‡§µ‡§∞‡§£:</strong> ${p.details}</p>
                     <p><strong>‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ:</strong> ${p.duration}</p>
                     <div class="action-buttons">
                         <button class="edit-btn" onclick="editPost('${p.id}')">‡§è‡§°‡§ø‡§ü ‡§ï‡§∞‡•á‡§Ç</button>
                         <button class="delete-btn" onclick="deletePost('${p.id}')">‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡•á‡§Ç</button>
                     </div>
                 </div>`;
         }).join('');
}

async function deletePost(postId) {
    if (confirm('‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§∏‡§ö ‡§Æ‡•á‡§Ç ‡§Ø‡§π ‡§™‡•ã‡§∏‡•ç‡§ü ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?')) {
        let posts = jobPostsList.filter(p => p.id !== postId);
        
        const adminData = await fetchDataFromFirebase();
        adminData.posts = posts;
        await saveAllDataToFirebase(adminData);
        jobPostsList = posts; 
        
        renderMyPosts(categoriesList); 
        renderAvailableJobs(categoriesList);
        if (document.getElementById('editingPostId').value === postId) {
            resetJobPostForm();
        }
    }
}

function editPost(postId) {
    const post = jobPostsList.find(p => p.id === postId);
    if (!post) return;

    switchSection('profileSection');
    
    document.getElementById('editingPostId').value = postId;
    document.getElementById('post_category').value = post.category;
    document.getElementById('post_work_details').value = post.details;
    document.getElementById('post_contact_name').value = post.contactName;
    document.getElementById('post_contact_number').value = post.contactNumber;
    document.getElementById('post_duration').value = post.duration;

    const btn = document.getElementById('submitJobPostBtn');
    btn.textContent = '‡§™‡•ã‡§∏‡•ç‡§ü ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç';
    btn.style.background = '#ffc107'; 

    btn.scrollIntoView({ behavior: 'smooth' });
}

async function switchSection(targetSectionId){
    document.querySelectorAll('.nav-item-bottom').forEach(n => n.classList.remove('active'));
    document.querySelector(`[data-section="${targetSectionId}"]`).classList.add('active');
    document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));
    document.getElementById(targetSectionId).classList.add('active');

    document.getElementById('loadingMessage').style.display = 'block';
    await fetchDataFromFirebase(); 
    document.getElementById('loadingMessage').style.display = 'none';

    switch(targetSectionId) {
        case 'homeSection':
            renderCategoryNav(categoriesList); 
            setFilter(currentFilter || 'all'); 
            break;
        case 'availableJobsSection':
            renderAvailableJobs(categoriesList);
            break;
        case 'profileSection':
            populatePostCategorySelect(categoriesList); 
            renderMyPosts(categoriesList); 
            resetJobPostForm(); 
            break;
    }

    window.scrollTo({ top: 0, behavior: 'smooth' });
}

document.addEventListener('DOMContentLoaded', async () => {
     await new Promise(resolve => setTimeout(resolve, 100)); 
     
     document.getElementById('jobPostForm').addEventListener('submit', handleJobPost);
     document.querySelectorAll('.bottom-nav .nav-item-bottom').forEach(item => {
         item.addEventListener('click', (e) => {
             e.preventDefault();
             switchSection(e.currentTarget.dataset.section);
         });
     });
     
     setupCategorySearch();
     
     switchSection('homeSection');
});
</script>

</body>
</html>
