<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä ‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§∏‡•á‡§µ‡§æ - ‡§ò‡§∞ ‡§™‡§∞ ‡§∏‡•á‡§µ‡§æ‡§è‡§Å</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <style>
    /* Base Styles */
    body { font-family: 'Poppins', sans-serif; margin: 0; background: #f7f7f9; color: #333; padding-bottom: 60px; }
    .container { padding: 20px; max-width: 1000px; margin: auto; }
    h1 { text-align: center; color: #007bff; margin-bottom: 20px; }
    h2 { color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-top: 20px; font-weight: 600; }
    .content-section { display: none; }
    .content-section.active { display: block; }

    /* Search + Category */
    .search-container { position: relative; margin-bottom: 20px; }
    #categorySearchInput { width: 100%; padding: 10px 40px 10px 15px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
    .search-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #007bff; }
    
    /* Styles for Suggestions */
    #categorySuggestions {
        position: absolute;
        width: 100%;
        max-height: 200px;
        overflow-y: auto;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 0 0 8px 8px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        z-index: 50;
        display: none; 
        top: 100%; 
    }
    .suggestion-item {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
        color: #333;
    }
    .suggestion-item:last-child {
        border-bottom: none;
    }
    .suggestion-item:hover {
        background: #e6f7ff;
        font-weight: 600;
    }
    .suggestion-highlight {
        color: #007bff;
        font-weight: 700;
    }

    .category-navbar { background: #fff; padding: 8px 0; border-bottom: 1px solid #eee; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .category-list { display: flex; overflow-x: auto; list-style: none; padding: 0 10px; margin: 0; scrollbar-width: none; }
    .category-list::-webkit-scrollbar { display: none; }
    .category-item { flex-shrink: 0; margin-right: 10px; }
    .category-link { padding: 8px 15px; border-radius: 20px; border: 1px solid #ccc; color: #333; background: #fff; text-decoration: none; display: block; white-space: nowrap; }
    .category-link.active { background: #007bff; color: #fff; border-color: #007bff; }

    /* Cards */
    .karmchari-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-top: 20px; min-height: 200px; }
    .karmchari-card { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 3px 8px rgba(0,0,0,0.1); border-left: 5px solid #007bff; }
    .category-tag { background: #ffc107; padding: 3px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; display: inline-block; margin-bottom: 5px; }
    .contact-buttons { display: flex; gap: 10px; margin-top: 10px; }
    .contact-buttons a { flex: 1; text-align: center; padding: 10px; border-radius: 5px; color: #fff; text-decoration: none; font-weight: 600; }
    .call-btn { background: #dc3545; }
    .whatsapp-btn { background: #28a745; }

    /* Job Card Styles */
    .job-card { background: #e6f7ff; border: 1px solid #cceeff; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 5px solid #007bff; }
    .job-card p { margin: 5px 0; }
    .job-card strong { color: #007bff; }
    .job-card .action-buttons { margin-top: 10px; display: flex; gap: 10px; }
    .job-card .action-buttons button { padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; flex: 1; }
    .job-card .edit-btn { background: #ffc107; color: #333; }
    .job-card .delete-btn { background: #dc3545; color: white; }
    
    /* Forms & Form Icons */
    .form-container { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-top: 15px; }
    .form-group-icon { position: relative; margin-bottom: 15px; }
    .form-group-icon .material-icons { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #007bff; font-size: 20px; pointer-events: none; }
    .form-group-icon input, .form-group-icon select, textarea {
        width: 100%; padding: 10px 10px 10px 40px; border-radius: 5px; border: 1px solid #ccc;
        box-sizing: border-box; transition: border-color 0.3s; 
    }
    textarea { padding-left: 10px !important; } /* Override icon padding for textarea */
    #employeeRegisterSection input, #employeeRegisterSection select { padding-left: 40px; }
    select { -webkit-appearance: none; -moz-appearance: none; appearance: none; padding-right: 10px; }
    
    /* Buttons */
    .form-btn { background: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; width: 100%; margin-top: 10px; font-weight: 600; transition: background 0.3s;}
    .form-btn:hover { background: #0056b3; }
    
    /* Advanced Button Style for Registration (IMPROVED) */
    #employeeRegisterForm button { 
        /* Base Styling */
        background: linear-gradient(135deg, #28a745, #1e8736); /* Subtle Gradient */
        color: white;
        padding: 12px 15px; /* Slightly taller */
        border: none;
        border-radius: 8px; /* Slightly larger border-radius */
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15), 0 1px 3px rgba(0, 0, 0, 0.08); /* 3D Shadow */
        cursor: pointer; 
        width: 100%; 
        margin-top: 15px; 
        font-weight: 700; /* Bolder text */
        text-transform: uppercase; /* Slightly more professional */
        letter-spacing: 0.5px;
        transition: all 0.2s ease;
        
        /* Flex for alignment */
        display: flex; 
        align-items: center; 
        justify-content: center; 
    }
    #employeeRegisterForm button:hover {
        background: linear-gradient(135deg, #1e8736, #156d2b); /* Darker on hover */
        box-shadow: 0 6px 10px rgba(0, 0, 0, 0.2), 0 2px 4px rgba(0, 0, 0, 0.1); /* Lift up effect */
    }
    #employeeRegisterForm button:active {
        transform: translateY(2px); /* Press down effect */
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Reduce shadow */
    }
    
    /* Success State for Button */
    #employeeRegisterForm button[style*="background: rgb(21, 87, 36)"] { /* Matches the success state color in JS */
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15); /* Keep shadow for success */
        transform: none;
    }

    /* Loading Spinner */
    .loading-spinner { 
        border: 2px solid #f3f3f3; 
        border-top: 2px solid #fff; 
        border-radius: 50%; 
        width: 16px; 
        height: 16px; 
        animation: spin 0.8s linear infinite; 
        margin-right: 8px; 
    }
    @keyframes spin { 
        0% { transform: rotate(0deg); } 
        100% { transform: rotate(360deg); } 
    }
    
    /* Messages */
    .message { margin-top: 10px; padding: 8px; border-radius: 4px; font-weight: bold; }
    .success-msg { color: #155724; background-color: #d4edda; border: 1px solid #c3e6cb; display: none; }
    

    /* Bottom Nav */
    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; display: flex; justify-content: space-around; background: #fff; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 10; }
    .nav-item-bottom { display: flex; flex-direction: column; align-items: center; padding: 6px 0; font-size: 0.8em; text-decoration: none; color: #777; flex-grow: 1; min-width: 60px; }
    .nav-item-bottom.active { color: #007bff; font-weight: 600; }
    .nav-item-bottom span { font-size: 22px; }
  </style>
</head>
<body>

<div class="container">
  <!-- 1. üè† ‡§π‡•ã‡§Æ ‡§∏‡•á‡§ï‡•ç‡§∂‡§® (‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä) -->
  <div id="homeSection" class="content-section active">
    <h1>‡§π‡§Æ‡§æ‡§∞‡•á ‡§Ö‡§®‡•Å‡§≠‡§µ‡•Ä ‡§∏‡•á‡§µ‡§æ ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä</h1>
    <div class="search-container">
      <input type="text" id="categorySearchInput" placeholder="‡§∂‡•ç‡§∞‡•á‡§£‡•Ä ‡§ñ‡•ã‡§ú‡•á‡§Ç...">
      <span class="material-icons search-icon">search</span>
      <!-- NEW: Category Suggestions Dropdown -->
      <div id="categorySuggestions"></div>
    </div>
    <div class="category-navbar">
      <ul id="categoryNav" class="category-list">
        <!-- Categories load here -->
      </ul>
    </div>
    <div id="karmchariGrid" class="karmchari-grid">
      <p id="loadingMessage" style="text-align:center;">‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</p>
    </div>
  </div>

  <!-- 2. üíº ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§ï‡§æ‡§Æ -->
  <div id="availableJobsSection" class="content-section">
    <h1>‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§ï‡§æ‡§Æ (<span id="jobPostCount">0</span> ‡§è‡§ï‡•ç‡§ü‡§ø‡§µ ‡§™‡•ã‡§∏‡•ç‡§ü)</h1>
    <div id="availableJobsContainer">
        <!-- Job posts render here -->
        <p style="text-align:center;">‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§Æ‡•á‡§Ç ‡§ï‡•ã‡§à ‡§ï‡§æ‡§Æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§</p>
    </div>
  </div>

  <!-- 3. ‚ûï ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ (‡§ú‡•Å‡§°‡§º‡•á‡§Ç) -->
  <div id="employeeRegisterSection" class="content-section">
    <h2>‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§™‡§Ç‡§ú‡•Ä‡§ï‡§∞‡§£ ‡§ï‡§∞‡•á‡§Ç</h2>
     <form id="employeeRegisterForm" class="form-container">
        
        <label for="emp_name">‡§Ü‡§™‡§ï‡§æ ‡§™‡•Ç‡§∞‡§æ ‡§®‡§æ‡§Æ</label>
        <div class="form-group-icon">
            <span class="material-icons">person</span>
            <input type="text" id="emp_name" placeholder="‡§ú‡•à‡§∏‡•á: ‡§Æ‡•ã‡§π‡§® ‡§≤‡§æ‡§≤" required>
        </div>
        
        <label for="emp_category">‡§Ü‡§™‡§ï‡•Ä ‡§µ‡§ø‡§∂‡•á‡§∑‡§ú‡•ç‡§û‡§§‡§æ (‡§∂‡•ç‡§∞‡•á‡§£‡•Ä)</label>
        <div class="form-group-icon">
            <span class="material-icons">engineering</span>
            <select id="emp_category" required>
                 <option value="">-- ‡§∂‡•ç‡§∞‡•á‡§£‡•Ä ‡§ö‡•Å‡§®‡•á‡§Ç --</option>
            </select>
        </div>

        <label for="emp_exp">‡§Ö‡§®‡•Å‡§≠‡§µ (‡§µ‡§∞‡•ç‡§∑‡•ã‡§Ç ‡§Æ‡•á‡§Ç)</label>
        <div class="form-group-icon">
            <span class="material-icons">military_tech</span>
            <input type="number" id="emp_exp" min="0" max="50" placeholder="‡§â‡§¶‡§æ‡§π‡§∞‡§£: 5" required>
        </div>
        
        <label for="emp_contact">‡§Ü‡§™‡§ï‡§æ ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§®‡§Ç‡§¨‡§∞ (WhatsApp/Call)</label>
        <div class="form-group-icon">
            <span class="material-icons">phone</span>
            <input type="text" id="emp_contact" inputmode="numeric" placeholder="91XXXXXXXXXX" required>
        </div>

        <!-- UPDATED BUTTON with icon and ID -->
        <button type="submit" id="registerEmployeeBtn">
            <span class="material-icons" id="registerIcon" style="font-size: 18px; vertical-align: middle; margin-right: 5px;">how_to_reg</span>
            <span id="registerText">‡§™‡§Ç‡§ú‡•Ä‡§ï‡§∞‡§£ ‡§ï‡§∞‡•á‡§Ç</span>
        </button>
        <p id="empRegisterMessage" class="message success-msg">‡§™‡§Ç‡§ú‡•Ä‡§ï‡§∞‡§£ ‡§∏‡§´‡§≤! ‡§Ü‡§™‡§ï‡§æ ‡§™‡•ç‡§∞‡•ã‡§´‡§º‡§æ‡§á‡§≤ ‡§π‡•ã‡§Æ ‡§™‡•á‡§ú ‡§™‡§∞ ‡§¶‡§ø‡§ñ‡§®‡•á ‡§≤‡§ó‡•á‡§ó‡§æ‡•§</p>
    </form>
  </div>

  <!-- 4. üë§ ‡§™‡•ç‡§∞‡•ã‡§´‡§º‡§æ‡§á‡§≤ (‡§ú‡•â‡§¨ ‡§™‡•ã‡§∏‡•ç‡§ü) -->
  <div id="profileSection" class="content-section">
    <h2>‡§ú‡•â‡§¨ ‡§∞‡§ø‡§ï‡•ç‡§µ‡•á‡§∏‡•ç‡§ü ‡§™‡•ã‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç</h2>
    <p>‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ‡§∏‡•á‡§µ‡§æ ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ø‡§π‡§æ‡§Å ‡§™‡•ã‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç‡•§</p>

    <form id="jobPostForm" class="form-container">
        <!-- Hidden field to track if we are editing -->
        <input type="hidden" id="editingPostId" value="">
        
        <label for="post_category">‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä ‡§∂‡•ç‡§∞‡•á‡§£‡•Ä</label>
        <div class="form-group-icon">
            <span class="material-icons">category</span>
            <select id="post_category" required>
                 <option value="">-- ‡§∂‡•ç‡§∞‡•á‡§£‡•Ä ‡§ö‡•Å‡§®‡•á‡§Ç --</option>
            </select>
        </div>

        <label for="post_work_details">‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£</label>
        <textarea id="post_work_details" rows="3" placeholder="‡§ú‡•à‡§∏‡•á: ‡§Æ‡•á‡§∞‡•á ‡§ò‡§∞ ‡§Æ‡•á‡§Ç ‡§™‡§æ‡§á‡§™ ‡§ü‡•Ç‡§ü ‡§ó‡§Ø‡§æ ‡§π‡•à, ‡§á‡§∏‡•á ‡§§‡•Å‡§∞‡§Ç‡§§ ‡§†‡•Ä‡§ï ‡§ï‡§∞‡§µ‡§æ‡§®‡§æ ‡§π‡•à‡•§" required></textarea>

        <label for="post_contact_name">‡§Ü‡§™‡§ï‡§æ ‡§®‡§æ‡§Æ</label>
        <div class="form-group-icon">
            <span class="material-icons">person</span>
            <input type="text" id="post_contact_name" required>
        </div>

        <label for="post_contact_number">‡§Ü‡§™‡§ï‡§æ ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§®‡§Ç‡§¨‡§∞ (WhatsApp/Call)</label>
        <div class="form-group-icon">
            <span class="material-icons">phone</span>
            <input type="text" id="post_contact_number" inputmode="numeric" placeholder="91XXXXXXXXXX" required>
        </div>

        <label for="post_duration">‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§ï‡§æ ‡§∏‡§Æ‡§Ø/‡§Ö‡§µ‡§ß‡§ø</label>
        <div class="form-group-icon">
            <span class="material-icons">schedule</span>
            <input type="text" id="post_duration" placeholder="‡§ú‡•à‡§∏‡•á: 4 ‡§ò‡§Ç‡§ü‡•á ‡§ï‡•á ‡§≤‡§ø‡§è, ‡§Ü‡§ú ‡§∂‡§æ‡§Æ ‡§ï‡•ã" required>
        </div>

        <button type="submit" class="form-btn" id="submitJobPostBtn">‡§ú‡•â‡§¨ ‡§∞‡§ø‡§ï‡•ç‡§µ‡•á‡§∏‡•ç‡§ü ‡§™‡•ã‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç</button>
        <p id="postMessage" class="message success-msg">‡§ú‡•â‡§¨ ‡§∞‡§ø‡§ï‡•ç‡§µ‡•á‡§∏‡•ç‡§ü ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§™‡•ã‡§∏‡•ç‡§ü ‡§ï‡•Ä ‡§ó‡§à!</p>
    </form>
    
    <h2 style="margin-top: 30px;">‡§Ü‡§™‡§ï‡•Ä ‡§™‡§ø‡§õ‡§≤‡•Ä ‡§™‡•ã‡§∏‡•ç‡§ü (<span id="myPostCount">0</span>)</h2>
    <div id="myPostsContainer">
        <!-- User's previous posts render here -->
        <p style="text-align: center; color: #555;">‡§Ü‡§™‡§ï‡•Ä ‡§ï‡•ã‡§à ‡§ú‡•â‡§¨ ‡§∞‡§ø‡§ï‡•ç‡§µ‡•á‡§∏‡•ç‡§ü ‡§™‡•ã‡§∏‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§ï‡•Ä ‡§ó‡§à ‡§π‡•à‡•§</p>
    </div>
  </div>
</div>

<!-- ‚öìÔ∏è ‡§¨‡•â‡§ü‡§Æ ‡§®‡•á‡§µ‡§ø‡§ó‡•á‡§∂‡§® -->
<div class="bottom-nav">
  <a href="#" class="nav-item-bottom active" data-section="homeSection">
    <span class="material-icons">engineering</span> ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä
  </a>
  <a href="#" class="nav-item-bottom" data-section="availableJobsSection">
    <span class="material-icons">work_outline</span> ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§ï‡§æ‡§Æ
  </a>
  <a href="#" class="nav-item-bottom" data-section="employeeRegisterSection">
    <span class="material-icons">person_add</span> ‡§ú‡•Å‡§°‡§º‡•á‡§Ç
  </a>
  <a href="#" class="nav-item-bottom" data-section="profileSection">
    <span class="material-icons">person</span> ‡§™‡•ç‡§∞‡•ã‡§´‡§º‡§æ‡§á‡§≤
  </a>
</div>

<script>
const STORAGE_KEY = 'serviceApp_admin_data_final';
const POST_STORAGE_KEY = 'serviceApp_job_posts';
const EMP_PREFIX = 'EMP_';
let currentFilter = 'all';
let userTrackedContact = localStorage.getItem('user_tracked_contact') || ''; // Track the user's contact number
let categoriesList = []; 

function generateId(prefix=''){return prefix+Date.now().toString(36)+Math.random().toString(36).substr(2,5);}

function loadData(){
    try {
        const d = localStorage.getItem(STORAGE_KEY);
        const parsedData = d ? JSON.parse(d) : { categories: [], employees: [] };
        if (!Array.isArray(parsedData.categories) || parsedData.categories.length === 0) {
             console.warn("Categories missing, using minimal seed data.");
             const seed = seedData();
             categoriesList = seed.categories; 
             return seed;
        }
        categoriesList = parsedData.categories; 
        return parsedData;
    } catch (e) {
        console.error("Error loading data, using minimal seed data.", e);
        const seed = seedData();
        categoriesList = seed.categories;
        return seed;
    }
}

function seedData(){
  const d={
    categories:[
      {id:'cat_plumber',name:'‡§™‡•ç‡§≤‡§Ç‡§¨‡§∞'},
      {id:'cat_electrician',name:'‡§á‡§≤‡•á‡§ï‡•ç‡§ü‡•ç‡§∞‡•Ä‡§∂‡§ø‡§Ø‡§®'},
      {id:'cat_carpenter',name:'‡§¨‡§¢‡§º‡§à'},
      {id:'cat_cleaner',name:'‡§∏‡§´‡§æ‡§à ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä'},
      {id:'cat_gardener',name:'‡§Æ‡§æ‡§≤‡•Ä'}
    ],
    employees:[
      {id:generateId(EMP_PREFIX),categoryId:'cat_plumber',name:'‡§∞‡§Æ‡•á‡§∂ ‡§ï‡•Å‡§Æ‡§æ‡§∞',experience:5,contact:'9876543210'},
      {id:generateId(EMP_PREFIX),categoryId:'cat_electrician',name:'‡§∏‡•Å‡§∞‡•á‡§∂ ‡§∏‡§ø‡§Ç‡§π',experience:8,contact:'9988776655'},
    ]
  };
  return d;
}

function loadPosts(){
    const posts = localStorage.getItem(POST_STORAGE_KEY);
    return posts ? JSON.parse(posts) : [];
}

function savePosts(posts){
    try {localStorage.setItem(POST_STORAGE_KEY, JSON.stringify(posts));} catch (e) {console.error("Post save error:", e);}
}
function saveData(data){try {localStorage.setItem(STORAGE_KEY,JSON.stringify(data));}catch (e) {console.error("Employee data save error:",e);}}
function saveTrackedContact(contact){
    userTrackedContact = contact;
    localStorage.setItem('user_tracked_contact', contact);
}


// --- Category Rendering and Filtering ---

function populateAllCategorySelects(categories) {
    const empSelect = document.getElementById('emp_category');
    const postSelect = document.getElementById('post_category');
    
    if (!empSelect || !postSelect) return; 

    const currentEmpVal = empSelect.value;
    const currentPostVal = postSelect.value;

    empSelect.innerHTML = '<option value="">-- ‡§∂‡•ç‡§∞‡•á‡§£‡•Ä ‡§ö‡•Å‡§®‡•á‡§Ç --</option>';
    postSelect.innerHTML = '<option value="">-- ‡§∂‡•ç‡§∞‡•á‡§£‡•Ä ‡§ö‡•Å‡§®‡•á‡§Ç --</option>';

    categories.forEach(cat => {
        // Employee Select
        let opt1 = new Option(cat.name, cat.id);
        empSelect.appendChild(opt1);
        
        // Post Select
        let opt2 = new Option(cat.name, cat.id);
        postSelect.appendChild(opt2);
    });
    
    // Attempt to restore selection
    empSelect.value = currentEmpVal;
    postSelect.value = currentPostVal;
}

function renderCategoryNav(data){
  const nav=document.getElementById('categoryNav');nav.innerHTML='';
  
  if (data.categories.length === 0) {
      nav.innerHTML = '<li class="category-item" style="color:#dc3545; padding: 0 20px;">‡§ï‡•ã‡§à ‡§∂‡•ç‡§∞‡•á‡§£‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡•§</li>';
      return;
  }
  
  // '‡§∏‡§≠‡•Ä ‡§∂‡•ç‡§∞‡•á‡§£‡§ø‡§Ø‡§æ‡§Ç' link
  const all=document.createElement('li');
  all.className='category-item';
  all.innerHTML=`<a href="javascript:void(0)" class="category-link ${currentFilter==='all'?'active':''}" data-category-id="all" data-category-name="‡§∏‡§≠‡•Ä ‡§∂‡•ç‡§∞‡•á‡§£‡§ø‡§Ø‡§æ‡§Ç">‡§∏‡§≠‡•Ä ‡§∂‡•ç‡§∞‡•á‡§£‡§ø‡§Ø‡§æ‡§Ç</a>`;
  all.querySelector('a').onclick=(e)=>{
      e.preventDefault(); 
      selectCategory('all', '‡§∏‡§≠‡•Ä ‡§∂‡•ç‡§∞‡•á‡§£‡§ø‡§Ø‡§æ‡§Ç');
  };
  nav.appendChild(all);

  // Individual categories
  data.categories.forEach(c=>{
    const li=document.createElement('li');
    li.className='category-item';
    li.innerHTML=`<a href="javascript:void(0)" class="category-link ${currentFilter===c.id?'active':''}" data-category-id="${c.id}" data-category-name="${c.name}">${c.name}</a>`;
    li.querySelector('a').onclick=(e)=>{
        e.preventDefault(); 
        selectCategory(c.id, c.name);
    };
    nav.appendChild(li);
  });
}

function setFilter(id){
  currentFilter=id;const d=loadData();
  renderEmployees(d,id);
  
  // Update the active filter text in search input if it's not set already by selectCategory
  const input = document.getElementById('categorySearchInput');
  const currentCategoryInInput = categoriesList.find(c => c.name === input.value);
  
  if (id === 'all' && input.value !== '‡§∏‡§≠‡•Ä ‡§∂‡•ç‡§∞‡•á‡§£‡§ø‡§Ø‡§æ‡§Ç') {
    input.value = ''; // Clear search input for 'all'
  } else if (id !== 'all' && (!currentCategoryInInput || currentCategoryInInput.id !== id)) {
    const cat = categoriesList.find(c => c.id === id);
    if (cat) {
        input.value = cat.name;
    }
  }

  // Highlight the active category link and scroll it into view
  document.querySelectorAll('.category-link').forEach(l=>{
    const isActive = l.dataset.categoryId===id;
    l.classList.toggle('active', isActive);
    if(isActive) l.parentElement.scrollIntoView({ behavior: 'smooth', inline: 'center' });
  });
}

function renderEmployees(data,filter){
  const grid=document.getElementById('karmchariGrid');
  grid.innerHTML='';
  
  const f=filter==='all'?data.employees:data.employees.filter(e=>e.categoryId===filter);
  
  if(!f.length){grid.innerHTML='<p style="text-align:center;color:red;">‡§ï‡•ã‡§à ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç‡•§</p>';return;}
  
  f.forEach(e=>{
    const c=data.categories.find(c=>c.id===e.categoryId) || {name: '‡§Ö‡§ú‡•ç‡§û‡§æ‡§§', id: 'unknown'};
    const cleanContact = String(e.contact).replace(/\D/g, ''); 
    const w=`https://wa.me/91${cleanContact}?text=${encodeURIComponent(`‡§®‡§Æ‡§∏‡•ç‡§§‡•á, ‡§Æ‡•Å‡§ù‡•á ${c.name} ‡§ï‡•Ä ‡§∏‡•á‡§µ‡§æ ‡§ö‡§æ‡§π‡§ø‡§è ‡§ú‡•ã ‡§Ü‡§™‡§®‡•á ‡§¶‡§ø‡§ñ‡§æ‡§Ø‡§æ ‡§π‡•à‡•§`)}`;
    
    const cardHTML = `
      <div class="karmchari-card">
        <div class="category-tag">${c.name}</div>
        <h3>${e.name}</h3>
        <p><strong>‡§Ö‡§®‡•Å‡§≠‡§µ:</strong> ${e.experience} ‡§∏‡§æ‡§≤</p>
        <div class="contact-buttons">
          <a href="tel:+91${cleanContact}" class="call-btn">‡§ï‡•â‡§≤ ‡§ï‡§∞‡•á‡§Ç</a>
          <a href="${w}" target="_blank" class="whatsapp-btn">‡§µ‡•ç‡§π‡§æ‡§ü‡•ç‡§∏‡§è‡§™</a>
        </div>
      </div>`;
    
    grid.insertAdjacentHTML('beforeend', cardHTML);
  });
}

// --- Search and Suggestions Logic ---

function renderSuggestions(query) {
    const suggestionsBox = document.getElementById('categorySuggestions');
    suggestionsBox.innerHTML = '';
    const categories = categoriesList;
    const lowerQuery = query.toLowerCase().trim();

    // Add '‡§∏‡§≠‡•Ä ‡§∂‡•ç‡§∞‡•á‡§£‡§ø‡§Ø‡§æ‡§Ç' option if query is empty
    if (query.length === 0) {
        suggestionsBox.innerHTML += `<div class="suggestion-item" data-category-id="all" data-category-name="‡§∏‡§≠‡•Ä ‡§∂‡•ç‡§∞‡•á‡§£‡§ø‡§Ø‡§æ‡§Ç">‡§∏‡§≠‡•Ä ‡§∂‡•ç‡§∞‡•á‡§£‡§ø‡§Ø‡§æ‡§Ç</div>`;
    }
    
    // Filter and display categories
    const filtered = categories.filter(cat => cat.name.toLowerCase().includes(lowerQuery));

    if (filtered.length === 0 && query.length > 0 && suggestionsBox.children.length === 0) {
        suggestionsBox.style.display = 'none';
        return;
    }

    filtered.forEach(cat => {
        const startIndex = cat.name.toLowerCase().indexOf(lowerQuery);
        const endIndex = startIndex + lowerQuery.length;
        const highlightedName = 
            cat.name.substring(0, startIndex) +
            `<span class="suggestion-highlight">${cat.name.substring(startIndex, endIndex)}</span>` +
            cat.name.substring(endIndex);

        suggestionsBox.innerHTML += `<div class="suggestion-item" data-category-id="${cat.id}" data-category-name="${cat.name}">${highlightedName}</div>`;
    });

    suggestionsBox.style.display = 'block';

    suggestionsBox.querySelectorAll('.suggestion-item').forEach(item => {
        item.addEventListener('mousedown', function() { 
            const id = this.dataset.categoryId;
            const name = this.dataset.categoryName;
            selectCategory(id, name);
        });
    });
}

function selectCategory(categoryId, categoryName) {
    document.getElementById('categorySearchInput').value = categoryName; 
    document.getElementById('categorySuggestions').style.display = 'none'; 
    setFilter(categoryId); 
}

function setupCategorySearch() {
    const input = document.getElementById('categorySearchInput');
    const suggestionsBox = document.getElementById('categorySuggestions');
    
    input.addEventListener('input', () => {
        renderSuggestions(input.value);
    });

    input.addEventListener('focus', () => {
        renderSuggestions(input.value);
    });

    input.addEventListener('blur', () => {
        setTimeout(() => {
            suggestionsBox.style.display = 'none';
        }, 150); 
    });
    
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            const firstSuggestion = suggestionsBox.querySelector('.suggestion-item');
            if (firstSuggestion && suggestionsBox.style.display === 'block') {
                e.preventDefault(); 
                const id = firstSuggestion.dataset.categoryId;
                const name = firstSuggestion.dataset.categoryName;
                selectCategory(id, name);
            } else if (input.value.trim() !== '') {
                const exactMatch = categoriesList.find(c => c.name.toLowerCase() === input.value.trim().toLowerCase());
                if (exactMatch) {
                    selectCategory(exactMatch.id, exactMatch.name);
                } else {
                     // If no exact match, clear the filter and reset input
                     selectCategory('all', ''); 
                }
            }
        }
    });
}


// --- Available Jobs Handlers ---

function renderAvailableJobs(categories) { 
    const posts = loadPosts();
    document.getElementById('jobPostCount').textContent = posts.length;
    const container = document.getElementById('availableJobsContainer');
    container.innerHTML = '';
    
    if (posts.length === 0) {
        container.innerHTML = `<p style="text-align: center; color: #555;">‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§Æ‡•á‡§Ç ‡§ï‡•ã‡§à ‡§ï‡§æ‡§Æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§</p>`;
        return;
    }
    
    posts.forEach(p => {
        const cat = categories.find(c => c.id === p.category);
        const catName = cat ? cat.name : '‡§Ö‡§ú‡•ç‡§û‡§æ‡§§';
        
        const wLink = `https://wa.me/91${p.contactNumber}?text=${encodeURIComponent(`‡§®‡§Æ‡§∏‡•ç‡§§‡•á, ‡§Æ‡•à‡§Ç‡§®‡•á ‡§Ü‡§™‡§ï‡•Ä ${catName} ‡§∏‡•á‡§µ‡§æ ‡§ï‡•Ä ‡§ú‡•â‡§¨ ‡§™‡•ã‡§∏‡•ç‡§ü ‡§¶‡•á‡§ñ‡•Ä ‡§π‡•à‡•§ ‡§ï‡•ç‡§Ø‡§æ ‡§Ø‡§π ‡§ï‡§æ‡§Æ ‡§Ö‡§≠‡•Ä ‡§≠‡•Ä ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§π‡•à? ‡§Æ‡•á‡§∞‡§æ ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§®‡§Ç‡§¨‡§∞ ${p.contactNumber} ‡§π‡•à‡•§`)}`;
        
        container.innerHTML += `
            <div class="job-card">
                <p><strong>‡§∂‡•ç‡§∞‡•á‡§£‡•Ä:</strong> ${catName}</p>
                <p><strong>‡§µ‡§ø‡§µ‡§∞‡§£:</strong> ${p.details}</p>
                <p><strong>‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ:</strong> ${p.duration}</p>
                <p><strong>‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§®‡§æ‡§Æ:</strong> ${p.contactName}</p>
                <div class="contact-buttons" style="margin-top:5px;">
                     <a href="tel:+91${p.contactNumber}" class="call-btn" style="flex:auto;">‡§ï‡•â‡§≤ ‡§ï‡§∞‡•á‡§Ç</a>
                     <a href="${wLink}" target="_blank" class="whatsapp-btn" style="flex:auto;">‡§µ‡•ç‡§π‡§æ‡§ü‡•ç‡§∏‡§è‡§™ ‡§ï‡§∞‡•á‡§Ç</a>
                </div>
            </div>
        `;
    });
}

// --- My Posts / Job Request Handlers ---

function resetJobPostForm(categories, isUpdate=false) {
    document.getElementById('jobPostForm').reset();
    
    if (userTrackedContact) {
        document.getElementById('post_contact_number').value = userTrackedContact; 
    }
    
    editingPostId = null;
    document.getElementById('editingPostId').value = '';
    
    const btn = document.getElementById('submitJobPostBtn');
    btn.textContent = '‡§ú‡•â‡§¨ ‡§∞‡§ø‡§ï‡•ç‡§µ‡•á‡§∏‡•ç‡§ü ‡§™‡•ã‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç';
    btn.style.background = '#007bff';
    populateAllCategorySelects(categories); 

    if(!isUpdate) document.getElementById('postMessage').style.display = 'none';
}

function handleJobPost(e) {
    e.preventDefault();
    
    const postForm = document.getElementById('jobPostForm');
    const id = document.getElementById('editingPostId').value || null;
    const category = document.getElementById('post_category').value;
    const details = postForm.querySelector('textarea#post_work_details').value.trim();
    const contactName = document.getElementById('post_contact_name').value.trim();
    const contactNumber = document.getElementById('post_contact_number').value.trim().replace(/\D/g, ''); 
    const duration = document.getElementById('post_duration').value.trim();
    
    const btn = document.getElementById('submitJobPostBtn');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.innerHTML = '<span class="loading-spinner"></span> <span>‡§™‡•ç‡§∞‡§∏‡§Ç‡§∏‡•ç‡§ï‡§∞‡§£...</span>';


    if (!category || !details || !contactName || contactNumber.length < 10 || !duration) {
        alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§≠‡•Ä ‡§´‡§º‡•Ä‡§≤‡•ç‡§° ‡§∏‡§π‡•Ä ‡§¢‡§Ç‡§ó ‡§∏‡•á ‡§≠‡§∞‡•á‡§Ç‡•§');
        btn.disabled = false;
        btn.innerHTML = originalText;
        return;
    }
    
    let posts = loadPosts();

    if (id) {
        // Handle Edit/Update
        const index = posts.findIndex(p => p.id === id);
        if (index !== -1) {
            posts[index] = {
                ...posts[index], 
                category: category,
                details: details,
                contactName: contactName,
                contactNumber: contactNumber,
                duration: duration
            };
            document.getElementById('postMessage').textContent = '‡§ú‡•â‡§¨ ‡§∞‡§ø‡§ï‡•ç‡§µ‡•á‡§∏‡•ç‡§ü ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡•Ä ‡§ó‡§à!';
            document.getElementById('postMessage').classList.remove('success-msg');
            document.getElementById('postMessage').classList.add('success-msg'); 
        }
    } else {
        // Handle New Post
        const newPost = {
            id: generateId('POST_'),
            category: category,
            details: details,
            contactName: contactName,
            contactNumber: contactNumber,
            duration: duration,
            timestamp: Date.now()
        };
        posts.push(newPost);
        document.getElementById('postMessage').textContent = '‡§ú‡•â‡§¨ ‡§∞‡§ø‡§ï‡•ç‡§µ‡•á‡§∏‡•ç‡§ü ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§™‡•ã‡§∏‡•ç‡§ü ‡§ï‡•Ä ‡§ó‡§à!';
    }
    
    savePosts(posts);
    saveTrackedContact(contactNumber); // Save the contact number for tracking
    
    const postMsg = document.getElementById('postMessage');
    postMsg.style.display = 'block';
    
    renderMyPosts(loadData().categories);
    resetJobPostForm(loadData().categories, true); 
    
    btn.disabled = false;
    btn.innerHTML = originalText;
    
    setTimeout(() => { 
        postMsg.style.display = 'none';
        if (document.getElementById('availableJobsSection').classList.contains('active')) {
             renderAvailableJobs(loadData().categories);
        }
    }, 3000);
}


function renderMyPosts(categories) { 
     const myPosts = loadPosts().filter(p => p.contactNumber === userTrackedContact); 
     document.getElementById('myPostCount').textContent = myPosts.length;
     const container = document.getElementById('myPostsContainer');
     container.innerHTML = '';
     
     if (!userTrackedContact || myPosts.length === 0) {
          container.innerHTML = `<p style="text-align: center; color: #555;">‡§Ü‡§™‡§ï‡•Ä ‡§ï‡•ã‡§à ‡§ú‡•â‡§¨ ‡§∞‡§ø‡§ï‡•ç‡§µ‡•á‡§∏‡•ç‡§ü ‡§™‡•ã‡§∏‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§ï‡•Ä ‡§ó‡§à ‡§π‡•à‡•§</p>`;
          if (userTrackedContact) {
             container.innerHTML += `<p style="text-align: center; color: #007bff; font-weight: 600;">‡§ä‡§™‡§∞ ‡§¶‡§ø‡§è ‡§ó‡§è ‡§´‡•â‡§∞‡•ç‡§Æ ‡§Æ‡•á‡§Ç ‡§ú‡•â‡§¨ ‡§∞‡§ø‡§ï‡•ç‡§µ‡•á‡§∏‡•ç‡§ü ‡§™‡•ã‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç‡•§</p>`;
          }
          return;
     }

     myPosts.forEach(p => {
        const cat = categories.find(c => c.id === p.category);
        const catName = cat ? cat.name : '‡§Ö‡§ú‡•ç‡§û‡§æ‡§§';
        
        container.innerHTML += `
            <div class="job-card" id="my-post-${p.id}">
                <p><strong>‡§∂‡•ç‡§∞‡•á‡§£‡•Ä:</strong> ${catName}</p>
                <p><strong>‡§µ‡§ø‡§µ‡§∞‡§£:</strong> ${p.details}</p>
                <p><strong>‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ:</strong> ${p.duration}</p>
                <div class="action-buttons">
                    <button class="edit-btn" onclick="editPost('${p.id}')">‡§è‡§°‡§ø‡§ü ‡§ï‡§∞‡•á‡§Ç</button>
                    <button class="delete-btn" onclick="deletePost('${p.id}')">‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡•á‡§Ç</button>
                </div>
            </div>
        `;
    });
}

function deletePost(postId) {
    if (confirm('‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§∏‡§ö ‡§Æ‡•á‡§Ç ‡§Ø‡§π ‡§™‡•ã‡§∏‡•ç‡§ü ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?')) {
        let posts = loadPosts();
        posts = posts.filter(p => p.id !== postId);
        savePosts(posts);
        const categories = loadData().categories;
        renderMyPosts(categories); 
        
        if (editingPostId === postId) {
            resetJobPostForm(categories);
        }
        renderAvailableJobs(categories); 
    }
}

function editPost(postId) {
    const post = loadPosts().find(p => p.id === postId);
    if (!post) return alert('‡§™‡•ã‡§∏‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡•§');

    editingPostId = postId;
    document.getElementById('editingPostId').value = postId;

    // Pre-fill the form
    document.getElementById('post_category').value = post.category;
    document.getElementById('post_work_details').value = post.details;
    document.getElementById('post_contact_name').value = post.contactName;
    document.getElementById('post_contact_number').value = post.contactNumber;
    document.getElementById('post_duration').value = post.duration;

    // Update button text and style
    const btn = document.getElementById('submitJobPostBtn');
    btn.textContent = '‡§™‡•ã‡§∏‡•ç‡§ü ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç';
    btn.style.background = '#ffc107'; 

    // Scroll to the form
    window.scrollTo({ top: document.getElementById('jobPostForm').offsetTop - 20, behavior: 'smooth' });
}


// --- Employee Registration Handler (UPDATED Button Animation) ---
function handleEmployeeRegistration(e) {
    e.preventDefault();
    
    const btn = document.getElementById('registerEmployeeBtn');
    const registerIcon = document.getElementById('registerIcon');
    const registerText = document.getElementById('registerText');
    const originalIcon = 'how_to_reg';
    const originalText = '‡§™‡§Ç‡§ú‡•Ä‡§ï‡§∞‡§£ ‡§ï‡§∞‡•á‡§Ç';

    // Show loading state
    btn.disabled = true;
    registerIcon.className = 'loading-spinner'; 
    registerIcon.style.marginRight = '8px';
    registerText.textContent = '‡§™‡§Ç‡§ú‡•Ä‡§ï‡§∞‡§£ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...';

    const name = document.getElementById('emp_name').value.trim();
    const categoryId = document.getElementById('emp_category').value; 
    const exp = parseInt(document.getElementById('emp_exp').value);
    const contact = document.getElementById('emp_contact').value.trim().replace(/\D/g, ''); 

    if (!name || categoryId === "" || isNaN(exp) || contact.length < 10) {
        alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§≠‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§∏‡§π‡•Ä ‡§¢‡§Ç‡§ó ‡§∏‡•á ‡§≠‡§∞‡•á‡§Ç‡•§'); 
        btn.disabled = false;
        registerIcon.className = 'material-icons';
        registerIcon.textContent = originalIcon;
        registerText.textContent = originalText;
        return;
    }

    let data = loadData();
    
    if (data.employees.some(emp => emp.contact === contact)) {
        alert('‡§Ø‡§π ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§®‡§Ç‡§¨‡§∞ ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§π‡•Ä ‡§™‡§Ç‡§ú‡•Ä‡§ï‡•É‡§§ ‡§π‡•à‡•§');
        btn.disabled = false;
        registerIcon.className = 'material-icons';
        registerIcon.textContent = originalIcon;
        registerText.textContent = originalText;
        return;
    }

    const newEmployee = {
        id: generateId(EMP_PREFIX), 
        categoryId: categoryId, 
        name: name,
        experience: exp, 
        contact: contact
    };

    data.employees.push(newEmployee);
    saveData(data); 

    // Show success state (briefly)
    registerIcon.className = 'material-icons';
    registerIcon.textContent = 'done_all'; 
    registerText.textContent = '‡§∏‡§´‡§≤!';
    btn.style.background = 'rgb(21, 87, 36)'; // Darker green for success - Matches success-msg color

    document.getElementById('employeeRegisterForm').reset();
    
    setTimeout(() => { 
        // Reset button and switch section
        btn.disabled = false;
        btn.style.background = ''; // Revert to CSS gradient
        registerIcon.textContent = originalIcon;
        registerIcon.className = 'material-icons';
        registerText.textContent = originalText;

        switchSection('homeSection'); 
        setFilter(categoryId); 
    }, 3000);
}


// --- Master Switcher ---
function switchSection(targetSectionId){
    const data = loadData();
    const categories = data.categories;

    // 1. Manage Active Class (UI)
    document.querySelectorAll('.nav-item-bottom').forEach(n => n.classList.remove('active'));
    document.querySelector(`[data-section="${targetSectionId}"]`).classList.add('active');
    document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));
    document.getElementById(targetSectionId).classList.add('active');

    // 2. Section Specific Logic
    if (targetSectionId === 'homeSection') {
         if (currentFilter === 'all' || !categoriesList.some(c => c.id === currentFilter)) {
             document.getElementById('categorySearchInput').value = ''; 
         }
         document.getElementById('categorySuggestions').style.display = 'none';
         
         if (!currentFilter) currentFilter = 'all';
         renderCategoryNav(data); 
         setFilter(currentFilter); 
         
    } else if (targetSectionId === 'availableJobsSection') {
         renderAvailableJobs(categories);
    } else if (targetSectionId === 'profileSection') { 
         populateAllCategorySelects(categories); 
         renderMyPosts(categories); 
         resetJobPostForm(categories); 
    } else if (targetSectionId === 'employeeRegisterSection') { 
         populateAllCategorySelects(categories); 
    }

    window.scrollTo({ top: 0, behavior: 'smooth' });
}


// --- Initialization ---

document.addEventListener('DOMContentLoaded', () => {
     loadData();
     
     document.getElementById('employeeRegisterForm').addEventListener('submit', handleEmployeeRegistration);
     document.getElementById('jobPostForm').addEventListener('submit', handleJobPost);
    
     document.querySelectorAll('.bottom-nav .nav-item-bottom').forEach(item => {
         item.addEventListener('click', function(e) {
             e.preventDefault();
             switchSection(this.getAttribute('data-section'));
         });
     });
     
     setupCategorySearch();
     
     switchSection('homeSection');
});
</script>

</body>
</html>
